# Docker Storage

When you install it on a sysstem, it creates this folder structure at `/var/lib/docker`. You have multiple folder under it called a aufs, containers, image, volumes, etc

``` 
$ tree
/var/lib/docker/
├── buildkit
├── containers
├── image
├── network
├── overlay2
├── plugins
├── runtimes
├── swarm
├── tmp
├── trust
└── volumes
```

For example, all files related to containers are stored under the `containers` folder, and the files related to images are stord under the `image` folder.

Any volumes created by the docker container are created under the `volumnes` folder.

## Layered Architecture


### Example 1
Example of Dockerfile
``` shell
# Dockerfile
FROM Ubuntu

RUN apt-get update && apt-get -y install python

RUN pip install flask flask-mysql

COPY . /opt/source-code

ENTRYPOINT FLASK_APP=/opt/source-code/app.py flask run

# End content Dockerfile

# Run command to build image

$ docker build Dockerfile -t jok3r/myapp

# Build layer 1: Base Ubuntu layer: 120MB
# Build layer 2: Changes in apt packages: 306MB
# Build layer 3: Changes in pip pakcages: 6.3MB
# Build layer 4: Source code: 229B
# Build layer 5: Update entrypoint 0B
```

For example, each line of instruction in the Dockerfle creates a new layer in the Docker image with just the changes from the previous layer.

The first layer is a base Ubuntu operating system, followed by the second instruction that creates a second layer which installs all the APT package.

And then, the third instruction creates a third layer, which with the Python packages followed by the fourth layer that copies the source code over.

An then finally, the fifth layer that updates the entrypoint of the image.

Since each layer only stores the changes from the previous layer, it it reflected in the size as well.

If you look at the base of the image, it it around in 120MB in size. The packages that are installed is around three hundred MB, and then the remaining layer are small.


### Example 2

``` shell
# Dockerfile2
FROM Ubuntu

RUN apt-get update && apt-get -y install python

RUN pip install flask flask-mysql

COPY app2.pt /opt/source-code

ENTRYPOINT FLASK_APP=/opt/source-code/app2.py flask run

# End content Dockerfile
$ docker build Dockerfile2 -t jok3r/myapp2
# Build layer 1: Base Ubuntu layer: ---
# Build layer 2: Changes in apt packages: ---
# Build layer 3: Changes in pip pakcages: ---
# Build layer 4: Source code: 229B
# Build layer 5: Update entrypoint 0B
```

When we run the docker build command to build a new image for this application, since the first three layers of both the applications are the same, Docker is not going to build the first three layers. 

Instead, it uses the same three layers it built for the first application from the cache and only creates the last two layers with new sources and the new entrypoint.

This way. docker builds images faster and efficiently , saves disk space.

**One the build is complete, you cannot modify the contents of these layers.**

So they are read only and you can only modify them by initialing a new build.

When you run a container based off a this image using the docker run command, Docker creates a container based off of the  these layers and creates a new writable layer on top of the image layer.

```docker run jok3r/myapp```

The writable layer is used to store data created by the container, such as log files, by the applications, any temporary fiels generated by the container or just any fiel modified by the user on that container.

The life of this layer, is only as long as the container is `alive`, when the container is destroyed, this layer and all of the changes stored in it are also destroyed.

## Copy on write

``` shell
container layers    -------------------------------------
                   |            Read Write               |
                   |                                     |
                   |                                     |
                    -------------------------------------
image layers        -------------------------------------
                   |            Read Only                |
                   |                                     |
                   |  app.py                             |
                    -------------------------------------
```

What's happends when we edit app.py? Beforce we save the apps which modified, Docker automatically creates a copy of the file in the read right layer and we will can be modifying a different version of the file in the retries layer.

``` shell
container layers    -------------------------------------
                   |            Read Write               |
                   |  app.py                             |
                   |                                     |
                    -------------------------------------
image layers        -------------------------------------
                   |            Read Only                |
                   |                                     |
                   |  app.py                             |
                    -------------------------------------
```

All future modifications will be done on this copy of the file in the rewrite layer. This is called copy on write mechanism.

The image layer being read only just means that the files in these layers will not be modified in the image itself. So the image will remain the same all the time until you rebuild the image using the docker build command.

What happends when we get deleted of the container. All of the data that was stored in the container layer also gets delted

## Volumes

``` shell
$ docker volume create data_volume
$ tree
/var/lib/docker/
├── volumes
    ├── data_volume

# To mount 
$ docker run -v data_volume:/var/lib/mysql mysql
```


```

 -----------------------------------------------------------
|  -----------------------                                  |
| |     Read Write        |                                 |
| |                       |                                 |
| |         /var/lib/mysql|                                 |
| |                |      |                                 |
| |mysql-container layer  |                                 |
|  ----------------|------                                  |
|       -----------|------                                  |
|      |  data_volume     |                                 |
|       ----------- ------                                  |
| -------------------------------------------------------   |
||                         Read Only                     |  |
||                                                       |  |
||                      mysql - image layer              |  |
| -------------------------------------------------------   |
 -----------------------Docker Host-------------------------
```

**For other example** 

```docker run -v /data/mysql:/var/lib/mysql msyql```

```

 -----------------------------------------------------------
|  -----------------------                                  |
| |     Read Write        |                                 |
| |                       |                                 |
| |         /var/lib/mysql|                                 |
| |                |      |                                 |
| |mysql-container layer  |                                 |
|  ----------------|------                                  |
|       -----------|------                                  |
|      |      mysql       |                                 |
|      |      /data       |                                 |
|       ----------- ------                                  |
| -------------------------------------------------------   |
||                         Read Only                     |  |
||                                                       |  |
||                      mysql - image layer              |  |
| -------------------------------------------------------   |
 -----------------------Docker Host-------------------------
```


## Storage driver

Some of common stories driver are:
- AUFS
- ZFS
- BTRFS
- Device Mapper
- Overlay
- Overlay2